name: Issue & PR Automation

on:
  issues:
    types: [opened, edited]
  pull_request:
    types: [opened, edited, ready_for_review]

jobs:
  label-by-type:
    name: Auto-label by Type
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Auto-label issues by content
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();

            // Auto-label by priority mentioned in body
            if (body.includes('p0') || body.includes('critical')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['P0']
              });
            } else if (body.includes('p1') || body.includes('high priority')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['P1']
              });
            } else if (body.includes('p2') || body.includes('medium priority')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['P2']
              });
            }

            // Auto-label by category
            if (title.includes('doc') || body.includes('documentation')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['documentation']
              });
            }

            if (title.includes('bug') || title.includes('fix')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['bug']
              });
            }

            if (title.includes('feat') || title.includes('feature') || title.includes('enhancement')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['enhancement']
              });
            }

            // Label by paper - check for explicit "paper N" mentions
            // Use word boundaries to avoid false matches like "paper 10" matching "paper 1"
            const paper1Match = /\bpaper\s*1\b/i.test(body) || /\bpaper1\b/i.test(body);
            const paper2Match = /\bpaper\s*2\b/i.test(body) || /\bpaper2\b/i.test(body);
            const paper3Match = /\bpaper\s*3\b/i.test(body) || /\bpaper3\b/i.test(body);

            if (paper1Match) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['paper-1']
              });
            }
            if (paper2Match) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['paper-2']
              });
            }
            if (paper3Match) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['paper-3']
              });
            }

  welcome-contributor:
    name: Welcome First-Time Contributors
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: Welcome first-time issue creator
        if: github.event_name == 'issues' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            // Check if this is their first issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: issue.user.login,
              state: 'all'
            });

            if (issues.data.length === 1) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `ðŸ‘‹ Welcome @${issue.user.login}! Thank you for opening your first issue in this repository.

                Please ensure you've followed the project guidelines in CLAUDE.md and CONTRIBUTING.md.

                A maintainer will review your issue shortly.`
              });
            }

      - name: Welcome first-time PR creator
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // Check if this is their first PR
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all'
            });

            const authorPRs = prs.data.filter(p => p.user.login === pr.user.login);

            if (authorPRs.length === 1) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `ðŸŽ‰ Congratulations @${pr.user.login} on your first pull request!

                **Pre-merge checklist:**
                - [ ] Run \`./validate_documentation.sh\` and ensure all tests pass
                - [ ] Run \`uv run ruff format .\` and \`uv run ruff check --fix .\`
                - [ ] Follow commit message format: \`type(scope): description\`
                - [ ] Link to related issue with "Resolves #XX"

                A maintainer will review your PR shortly. Thank you for contributing!`
              });
            }

  stale-issue-check:
    name: Mark Stale Issues
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Mark stale issues
        uses: actions/stale@v9
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          stale-issue-message: >
            This issue has been automatically marked as stale because it has not had
            recent activity. It will be closed if no further activity occurs within 7 days.
            If this issue is still relevant, please comment to keep it open.
          stale-pr-message: >
            This pull request has been automatically marked as stale because it has not had
            recent activity. It will be closed if no further activity occurs within 7 days.
            Please update the PR if you'd like to continue working on it.
          days-before-stale: 90
          days-before-close: 7
          stale-issue-label: 'stale'
          stale-pr-label: 'stale'
          exempt-issue-labels: 'P0,P1,in-progress'
          exempt-pr-labels: 'in-progress,work-in-progress'
